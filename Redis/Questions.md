# 原理

##### Redis 为什么快

  - 基于内存
  - 单线程，省去了很多上下文切换线程的时间，也不需要竞争锁
  - 数据结构简单、高效
  - 利用 IO多路复用监听事件、事件驱动



##### 为什么采用单线程？

- 首先必须明确，`redis` 单线程指的是网络请求模块使用了一个线程，其他模块有的用的是多线程，并不是一个线程完成了所有功能。
- 原理上，其采用了利用 `epoll` 的多路复用特性，因此可以采用单线程处理其网络请求。
- `6.0` 以后，使用了多线程处理网络读和写。



##### 什么情况下使用 redis

1. 针对热点数据进行缓存
2. 对于特定限时数据的存放
3. 针对带热点权值数据的排序 `list`
4. 分布式锁



##### 与memcache的区别

1. `redis` 处理网络请求采用单线程模型，而 `memcache` 采用多线程的方式
2. `redis` 支持数据持久化，`memcache` 不支持
3. `redis` 支持的数据格式比 `memcache` 更多（一般选型都是这个原因）





# 穿透、击穿、雪崩

#### 缓存穿透

缓存穿透指缓存和数据库均没有需要查询的数据，攻击者不断发送这种请求，使数据库压力过大。

##### 解决方法

1. 前置过滤
   1. 在数据库操作访问前进行校验，对不合法请求直接返回
   2. 每天定时使用布隆过滤器存储所有 `key` 的集合，先判断 `key` 在不在，再查 `redis / DB`
2. 对于经常被访问的，并且数据库没有的 `key`，缓存该 `key` 的值为 `null`。不过这个得设较短的过期时间，防止数据长时间不一致。
3. 如果还有问题，那么就是限流、降级了



#### 缓存击穿

缓存击穿指某缓存数据时间到期，但由于并发访问该数据的请求特别多，导致大量请求打到数据库

**解决方法**

1. 设置热点数据永远不过期。
2. 读数据库时加锁，降低并发性。



#### 缓存雪崩

缓存雪崩指缓存中一大批数据同时到过期时间。导致大量请求打到数据库

**解决方法**

1. 缓存数据设置随机过期时间，防止同一时间大量数据过期。
2. 设置热点数据永远不过期。



#### 脑裂

是指因为网络问题，导致 `master` 节点未宕机的情况下，`sentinel / 其余master` 因为连接不上 `master`，所以将 `slave` 提升为 `master` 。此时存在两个不同的 `master` 节点。

如果客户端还在基于原来的 `master` 继续写入数据，那么新的 `master` 节点将无法同步这些数据，当网络问题解决之后，原先的 `master` 被降为 `slave` ，此时再从新的 `master` 中同步数据，将会造成大量的数据丢失。

##### 解决方法

设置 `min-slaves` 参数，在主从同步失败时拒写。





# 高可用

**Redis有哪些集群部署方式**

1. 主从复制
2. 哨兵模式
3. `cluster` 集群模式



**简述主从复制模式**

在主从复制中，有主库 `master` 节点和从库 `slave` 节点两个角色。从节点服务启动会连接主库，并向主库发起 `SYNC` 命令。

主节点收到同步命令，启动持久化工作，工作执行完成后，主节点将传送整个数据库文件到从库，从节点接收到数据库文件数据之后将数据进行加载。此后，主节点继续将所有已经收集到的修改命令，和新的修改命令依次传送给从节点，从节点依次执行，从而达到最终的数据同步。

通过这种方式，可以使写操作作用于主库，而读操作作用于从库，从而达到读写分离。



**简述哨兵模式**

哨兵模式监控 `redis` 集群中 `master` 的工作的状态。在 `master` 主服务器宕机时，从 `slave` 中选择新机器当作 `master`，保证系统高可用

每个哨兵每10秒向主服务器，`slave` 和其他哨兵发送 `ping`

客户端通过哨兵查询可供服务的 `redis master` 节点

哨兵只需要配 `master` 节点，会自动寻找其对应的 `slave` 节点。

监控同一 `master` 节点的哨兵会自动互联，组成哨兵网络，当任一哨兵发现 `master` 连接不上，即开会投票，投票半数以上决定 `master` 下线，并从 `slave` 节点中选取新的 `master` 节点上位。



**cluster集群**

`cluster` 提出了虚拟槽的概念。

1. `redis cluster` 默认有16384个槽。
2. 执行命令时，`redis` 先对 `key` 经过 `CRC16 hash` 运算，并把结果对16384取余，得到槽编号。
3. 根据槽编号，寻找到其对应的 `redis` 节点，在节点上执行命令。








#### 参考

> [后端技术小牛说](https://mp.weixin.qq.com/s/paHphwGFE9AsJFWkayZkCg)
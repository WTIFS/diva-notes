主从同步分为 2 个步骤：同步和命令传播



# 主从复制原理

首先，Redis 的复制分为 **同步**(sync) 和 **命令传播**(command propagate) 两个操作：

 

### 同步（rdb全量同步）

1. 从服务器向主服务器发送 `sync` 命令
2. 收到 `sync` 命令后，主服务器执行 `bgsave` 命令，用来生成 rdb 文件，并在一个缓冲区中记录从现在开始执行的写命令。
   - 复制积压缓冲区是一个固定长度、先进先出的队列，默认 1MB。
3. `bgsave` 执行完成后，将生成的 rdb 文件发送给从服务器，用来给从服务器更新数据
4. 主服务器再将缓冲区记录的写命令发送给从服务器，从服务器执行完这些写命令后，此时的数据库状态便和主服务器一致了。
5. `bgsave` 会耗CPU、内存、磁盘，发给从节点会耗费网络。发送期间，从节点不可用。



### 命令传播

主服向从发送写命令（推）



# 断线重连
- 2.8 之前，重连会直接全量重新同步数据
- 2.8 开始，用 `psync` 代替 `sync`，以实现部分同步。
    - 向主服务器发送 `PSYNC [主服务器ID] [上次同步位置]`
    - 主进行命令传播时会一并写入缓冲区。
    - 如果从节点最近的复制偏移量在这个缓冲区里，就从复制偏移量之后开始同步
    - 否则还是全量同步



### Run id

在进行初次复制时，主服务器将会将自己的运行 id 发送给从服务器，让其保存起来。

当从服务器断线重连后，从服务器会将这个运行 id 发送给刚连接上的主服务器。

若当前服务器的运行 id 与之相同，说明从服务器断线前复制的服务器就是当前服务器，主服务器可以尝试执行部分同步；若不同则说明从服务器断线前复制的服务器不是当前服务器，主服务器直接执行完整重同步。



### 心跳

完成了同步之后，主从服务器就会进入命令传播阶段，此时从服务器会以每秒 1 次的频率，向主服务器发送命令：`REPLCONF ACK <replication_offset>` 
其中 `replication_offset` 是从服务器当前的复制偏移量

发送这个命令主要有三个作用：
- 检测主从服务器的网络状态
- 辅助实现 min-slaves 选项
- 检测命令丢失（若丢失，主服务器会将丢失的写命令重新发给从服务器）



#### 参考

> [蘑菇睡不着 - 详解Redis主从复制](https://segmentfault.com/a/1190000040248346)
# 哨兵模式

当主服务器中断服务后，可以将一个从服务器升级为主服务器，以便继续提供服务，但是这个过程需要人工手动来操作。 为此，`Redis 2.8` 中提供了哨兵工具来实现自动化的系统监控和故障恢复功能。

哨兵的作用就是监控 `Redis` 系统的运行状况。它的功能包括以下两个：

1. 监控主服务器和从服务器是否正常运行。 

2. 主服务器出现故障时自动将从服务器转换为主服务器。





### 主节点选取

- 每个 `sentinel`（哨兵）进程以每秒钟一次的频率向整个集群中的 `master` 主服务器，`slave` 从服务器以及其他 `sentinel` 进程发送一个 `PING` 命令
- 如果一个实例距离最后一次有效回复 `PING` 命令的时间超过 `down-after-milliseconds` 选项所指定的值， 则这个实例会被哨兵进程标记为主观下线 `SDOWN`
- 如果一个 `master` 被标记为主观下线 `SDOWN`，则正在监视这个 `master` 的所有 `sentinel` 进程会以每秒一次的频率确认 `master` 的确进入了主观下线状态
- 当有足够数量的 `sentinel`（大于等于配置文件指定的值）在指定的时间范围内确认 `master` 进入了主观下线状态， 则 `master` 会被标记为客观下线 `ODOWN`
- 在一般情况下，每个 `sentinel` 进程会以每 `10` 秒一次的频率向集群中的所有 `master` 、`slave` 从服务器发送 `INFO` 命令。
- 当 `master` 主服务器被 `sentinel` 进程标记为客观下线 `ODOWN` 时，`sentinel` 进程向下线的 `master` 的所有 `slave` 发送 `INFO` 命令的频率会从 `10` 秒一次改为每秒一次。
- 若没有足够数量的 `sentinel` 进程同意 `master` 下线， `master` 的客观下线状态就会被移除。若 `master` 重新向 `sentinel` 的 `PING` 命令返回有效回复，`master` 的主观下线状态就会被移除。





### 哨兵模式的优缺点

#### 优点

- 哨兵模式是基于主从模式的，所有主从的优点，哨兵模式都具有。
- 主从可以自动切换，系统更健壮，可用性更高。

#### 缺点

- 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。





### raft协议

`sentiel` 和 `cluster` 的主节点选取，参考了 `raft` 协议（是否就是 `raft` 协议，存疑。有的说是，但实现细节上是有不同的）

至于主从同步、数据一致性，则完全没有使用 `raft` 协议。`raft` 要求主节点收到命令后，至少同步给一定的从节点后，才视为成功返回结果。而 `redis` 是全异步的，主节点写成功就视为成功。

 `redislab` 有个 `redis` 的插件，以插件的形式，专门使用 `raft` 实现了分布式一致。
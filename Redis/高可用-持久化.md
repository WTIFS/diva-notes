# 持久化

##### 简述Redis的 RDB

`RDB` 即将当前数据生成快照，并保存于硬盘中。可以通过手动命令，也可以设置自动触发。



##### 简述 Redis 的 save 命令

`save` 命令是 `redis` 手动触发 `RDB` 过程的命令。使用该命令后，服务器阻塞，直到 `RDB` 过程完成后终止。该过程占用内存较多。



##### 简述 Redis 的 bgsave 命令

`bgsave` 命令不阻塞主进程（也不是全程不阻塞，详看下面过程），该命令 `fork` 一个子进程用于执行 `RDB` 过程。其具体过程为：

1. 判断此时有没有子进程用于 `RDB`，有的话直接返回。
2. `redis` 进行 `fork` 子进程过程，此时父进程处于阻塞状态。
3. 子进程创建 `RDB` 文件，完成后返回给父进程

> `fork` 进程会导致子进程复制父进程的的内存，如果父进程内存占用过大，复制一遍可能导致 `OOM`。此情况下 `linux` 提供了一个参数 `/proc/sys/vm/overcommit_memory`，默认为0，会复制。可以改为 1，表示循序子进程共享父进程的内存，复制时只复制变化的部分，从而减少内存占用。



##### 简述 Redis 自动触发 RDB 机制

1. 通过配置文件，设置一定时间后自动触发 `RDB`
2. 如采用主从复制过程，主节点自动执行 `bgsave` 生成 `RDB` 并发送给从节点
3. 默认执行 `shutdown` 时，在未开启 `AOF` 后会自动执行 `bgsave`



##### 简述 Redis 的 AOF

`AOF` 通过日志，对数据的写入修改操作进行记录。这种持久化方式实时性更好。可以通过配置文件打开 `AOF`。



##### 简述 AOF 的持久化策略

`AOF` 写日志时并不是直接写到硬盘上，而是先写内存缓冲区，再写入硬盘。写入硬盘的实际可以配置三种：

1. `always`。每执行一次数据修改命令就将其命令写入到磁盘日志文件上。
2. `everysec`。每秒将命令写入到磁盘日志文件上（默认）。
3. `no`。不主动设置，由操作系统决定什么时候写入到磁盘日志文件上。



##### 简述 AOF 的重写

随着客户端不断进行操作，`AOF` 对应的文件也越来越大。`redis` 提供了 `bgrewriteaof` 函数， 把 `redis` 进程内的数据转化为写命令同步到新 `AOF` 文件，减小文件体积。

可以通过配置设置自动触发阈值。



##### RDB 与 AOF 优缺点比较

`RDB` 是物理日志，优势是体积小，内部用了 `LZF` 压缩。并且加载 `RDB` 恢复速度也远高于 `AOF`。

`AOF`是逻辑日志，备份对系统的消耗比较低，写入快，实时性好。



#### 参考

> [码猿技术专栏 - 天天用Redis，持久性优化方案你知道多少](https://juejin.cn/post/6844904132164190215)


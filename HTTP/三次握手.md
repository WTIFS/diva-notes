#### 三次握手

三次握手（Three-way Handshake）其实就是指建立一个TCP连接时，需要客户端和服务器总共发送3个包。进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备。

刚开始客户端处于 `Closed` 的状态，服务端处于 `Listen` 状态。



##### 缩写

`SYN`: `Synchronize Sequence Numbers`，同步序列号

`ISN`: `Initial Sequence Number`，初始同步序列号



##### 第一次握手

客户端给服务端发一个 `SYN` 报文，并指明客户端的初始化序列号 `ISN`。

此时客户端处于 `SYN_SENT` 状态。



##### 第二次握手

服务器收到客户端的 `SYN` 报文之后，会回复一个 `ACK`  报文作为应答，把客户端的 `ISN + 1` 作为 `ACK` 的值，表示已经收到了客户端的 `SYN`。并且指定自己的初始化序列号 `ISN`。

此时服务器处于 `SYN_REVD` 的状态。



##### 第三次握手

客户端收到 `SYN` 报文之后，会回复一个 `ACK` 报文，也是一样把服务器的 `ISN + 1` 作为 `ACK` 的值，表示已经收到了服务端的 `ACK` 。

此时客户端处于 ` ESTABLISHED` 状态。服务器收到 `ACK` 报文之后，也会变为 `ESTABLISHED` 状态，双方就建立起了连接。



发送第一个 `SYN` 的一端将执行主动打开（active open），接收这个 `SYN` 并发回下一个 `ACK` 的另一端执行被动打开（passive open）



![img](assets/v2-2a54823bd63e16674874aa46a67c6c72_720w.jpg)



#### 为什么需要三次握手

弄清这个问题，我们需要先弄明白三次握手的目的是什么，能不能只用两次握手来达到同样的目的。

三次握手的目的是建立**可靠**的连接，两次握手无法达到这个目的。



##### 第一次握手：客户端发送网络包，服务端收到了。

这样服务端就能得出结论：客户端的发送能力是正常的。



##### 第二次握手：服务端发包，客户端收到了。

这样客户端就能得出结论：服务端的接收、发送能力是正常的。不过此时服务器并不能确认客户端的接收能力是否正常。

如果这个阶段就视为连接建立成功，那么后续服务端发送的数据，客户端可能收不到，这是**不可靠连接**。



##### 第三次握手：客户端发包，服务端收到了。

这样服务端就能得出结论：客户端的接收、发送能力正常。

因此，需要三次握手才能确认双方的接收与发送能力是否正常。





#### **半连接队列**

服务器第一次收到客户端的 `SYN` 之后，会处于 `SYN_RCVD` 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，称为半连接队列。

当然还有一个全连接队列，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。

服务器发送完 `ACK` 包，如果未收到客户确认包，则会进行退避式重传。如果重传次数超过配置的最大重传次数，则会将该连接信息从半连接队列中删除。



##### SYN攻击

服务器端的资源分配是在二次握手时分配的，而客户端的资源是在完成三次握手时分配的，所以服务器容易受到 `SYN` 洪泛攻击。`SYN` 攻击就是 Client 在短时间内伪造大量不存在的 IP 地址，并向 Server 不断地发送 `SYN` 包，Server 则回复确认包，并等待 Client 确认，由于源地址不存在，因此 Server 需要不断重发直至超时，这些伪造的 `SYN` 包将长时间占用半连接队列，导致正常的 `SYN` 请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪。`SYN` 攻击是一种典型的 `DoS/DDoS` 攻击。

检测 `SYN` 攻击非常的方便，当你在服务器上看到大量的**半连接状态**的连接时，特别是源 IP 地址是随机的，基本上可以断定这是一次 `SYN` 攻击。在 `Linux/Unix` 上可以使用系统自带的 `netstats` 命令来检测 `SYN` 攻击。



#### ISN 是固定的吗？

是动态随机生成的。

当一端为建立连接而发送它的 `SYN` 时，它会为连接设一个初始序号。`ISN` 随时间而变化，因此每个连接都将具有不同的 `ISN`。`ISN` 可以看作是一个 `32 bit` 的计数器，每 `4ms` 加 `1` 。

这样选择序号的目的在于：

1. 防止在网络中被延迟的分组在以后又被传送，而导致某个连接的一方对它做错误的解释。
2. 增加安全性。如果 `ISN` 是固定的，攻击者很容易猜出后续的确认号。



#### 三次握手过程中可以携带数据吗？

其实第三次握手的时候，是可以携带数据的。但是，第一次、第二次握手不可以携带数据

假如第一次握手可以携带数据的话，如果有人要恶意攻击服务器，那他每次都在第一次握手中的 `SYN` 报文中放入大量的数据，重复发 `SYN` 报文的话，会大量浪费服务器的资源。

而对于第三次的话，此时客户端已经处于 `ESTABLISHED` 状态。对于客户端来说，他已经建立起连接了，并且也已经知道服务器的接收、发送能力是正常的了，所以能携带数据也没啥毛病。



#### 参考

> [GitHubPorn - 关于三次握手和四次挥手](https://www.zhihu.com/question/271701044/answer/1935194322)


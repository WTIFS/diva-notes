# 4S分析法

- Senario：场景、特征
  - 问清楚需要的功能，节选核心功能来实现
  - 现有的架构是什么样子？服务器、数据库、缓存之间的关系及数量
  - 访问量、并发用户数、数据量、空间使用量；读频率、写频率；现有瓶颈、压力
  - 分析服务特征
- Service：服务拆分
- Storage：存储
  - 不同的服务使用不同的存储，如推特的用户服务用 MySQL，推文服务用 Mongo，图片服务用 S3
- Scale：扩展、分片、优化



# 高并发


#### 架构层面

- 分层、负载均衡、健康检查机制
- 服务分布式化、无状态化，支持水平弹性扩容
- 缓存
- 调用链路热点前置（如CDN
- 提前容量规划（如使用商品预约功能预估流量
- 前后端、网关限流



#### 代码层面

- fail fast 快速失败
- 非主干逻辑异步化
- 可以并行的逻辑做成多线程处理
- 锁优化（采用无锁数据结构）
- 本地缓存
- 代码分层，减少耦合：接口层（Controller）、应用层（Service）、领域层（Model）、基础设施层（DAO）



#### 数据库

- 根据不同的存储诉求来进行不同的存储选型
- 索引设计，利用覆盖索引避免回表、排序等
- 分库分表、读写分离、数据分片
- 热点数据拆分、隔离、分片





# 高可用

- 网关：LVS（综合性价比最好） / HaProxy (并发和CPU都高) / Nginx (并发和CPU都低)
  - 负载均衡：轮询 / RR / IP Hash / 加权等算法
  - 健康检查：故障自动发现、自动摘除、自动重试、服务恢复自动发现
- 服务：分布式化、无状态化，支持水平弹性扩容
- 熔断、限流、降级
- 服务发布：灰度发布（金丝雀发布）、蓝绿发布（新建容器发布后切换）





# 一致性

- 分布式事务
  - 2PC、3PC、TCC、Sega 等机制
  - 本地消息表、最大努力重试机制
- 分布式锁
  - zk / etcd / redlock 
  - 一致性算法：Paxos / Raft / zab
- 幂等
# 高并发

一般和高性能一起讲

#### 设计层面

- 服务分布式化、无状态化，支持水平弹性扩容
- 网关：负载均衡
- 使用缓存，多级缓存
- 调用链路热点前置（如CDN
- 提前容量规划（如使用商品预约功能预估流量
- 前后端限频、网关限流，阻拦不合理流量，进而保证能处理正常流量



#### 代码层面

- fail fast 快速失败
- 非主干逻辑异步化
- 可以并行的逻辑做成多线程处理
- 减小锁粒度；利用分片减小锁范围或无锁化
- 本地缓存
- 合并连续请求，一次性批量处理，减小网络传递流量



#### 数据库

- 根据不同的存储诉求来进行不同的存储选型
- 设计合理的索引，利用覆盖索引避免回表、排序等
- 分库分表、读写分离、数据分片
- 热点数据拆分、隔离、分片



# 高可用

先明确概念：部分节点挂掉的情况下，仍能提供全部/正常服务

总体思路：1. 预防，2. 合理设计保证故障时可用

- 研发规范
  - 代码规范、单测：减少 bug，提高健壮性
  - 日志：设计良好的日志能加速发现问题
- 设计层面
  - 做好容量规划和评估，对系统要抗住的量级有基本认知，以便设计合理的架构和演进
  - 做好压测
- 服务层面
  - 网关：健康检查、故障自动发现、自动重试、自动摘除、服务恢复自动发现
  - 无状态服务、弹性扩缩容
  - 阻拦不合理流量：鉴权、限流
  - 异步解耦和削峰设计
    - 异步解耦：如果消费方异常，并不影响生产方，生产方依然可以对外提供服务。消费者恢复后可以继续从消息队列里面消费数据
    - 削峰：不会因为有突发流量而把整个系统打垮
  - 过载保护
    - 限流
    - 熔断，保护下游
    - 降级，保证核心功能可用，不至于整个服务完全不可用
- 存储层面
  - 集中式存储
    - 读写分离
    - 分库分表（部分分区挂了不影响其他）
    - 冷热分离
    - 备份（一主多从、一主多备）
    - 失效转移（主从切换）
  - 分布式存储
    - HDFS、HBase、ES等
- 运维层面
  - 服务发布：灰度发布（金丝雀发布）、蓝绿发布（新建容器发布后切换）
  - 监控告警
  - 防攻击设计
    - 网关做好防刷和鉴权
    - 服务内部做好登录态、鉴权逻辑
  - 容灾
    - 多机房部署
  - 故障演练
  - 接口拨测
    - 和巡检类似，每隔一个固定时间调用后端的各种接口，如果接口异常则进行告警
- 产品层面
  - 兜底策略
    - 比如页面获取不到数据的时候，或者无法访问的时候，要如何友好的告知用户，比如【稍后重试】之类的。
    - 比如页面无法访问的时候，那么需要产品提供一个默认页面，如果后端无法获取真实数据，那么直接渲染默认页面。
    - 比如服务器需要停机维护，那么产品层面给一个停机页面，所有用户只会弹出这个停机页面，不会请求后端服务
- 应急预案
  - 出现问题后怎么快速恢复，不至于让异常事态扩大
  - 依赖的其他服务出现问题的时候，要尽快的进行降级、兜底等各种异常保护措施



### 参考

[AllenWu - 工作十年，谈谈我的高可用架构和系统设计经验](https://mp.weixin.qq.com/s?__biz=MzkyNTI5NTQ1NQ==&mid=2247511260&idx=1&sn=74b94bfb54993cef6d92d00471cc20c7&chksm=c1ca5aecf6bdd3fa7da88ac44ca21fd6ae792afc8ab0e9ac6ea17c4528dac9182d54b0b427d4&scene=126&sessionid=0)
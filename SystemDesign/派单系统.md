# 基本逻辑

美团的外卖订单、滴滴的行程单，本质都是带坐标的订单，至少要包括如下字段

```go
type TripOrder struct {
    UserID int
    Departure Location   // 出发地
    Destination Location // 目的地
}
```

基本思路是：将行程单放入一个队列里面，司机从这个队列里面去接单，每次 pop 出来一笔行程单

问题：不能将北京市所有的乘客的行程单放入到队列去维护，然后让所有北京司机都去队列里面接单，效率太低

优化：拆分队列。让每个乘客的行程单进入到离他最近的队列中去，可以利用 Geohash 划分服务网格为独立队列、热点区域也要做单独的队列

实现：QPS为千级别，队列可以用 DB，也可以用 redis，或者服务器内存做。以网格 ID 为 key / 索引



# 派单算法

滴滴最早是抢单模式，不需要派单算法。缺点：应答率低；路上抢单有安全问题；效率问题局部最优并不会带来全局最优

后来改为派单模式，应答率有了20%以上的提升，很多时候全天能高达90%；派单能优化整体交易效率（配送成本）和用户体验（时长）

就近分配：70%~80%的订单

规则过滤：快车、专车的车型匹配；限号匹配；过滤不顺路区域；去重，同一订单只发送一次等

批量匹配：Batching Matching，延迟集中分单。在时间维度上贪婪的分单方式（即每个订单出现时即选择附近最近的司机派单）并不能获得全局最优的效果。一个自然的想法就是先让乘客和司机稍等一会，待收集了一段时间的订单和司机信息后，再集中分配

机器学习：

整个派单算法核心克服的是未来供需的不确定性，动态的时空结构的建模，以及用户行为的不确定性，对于这些不确定性我们现在更多采用深度学习方法对我们的时空数据&用户行为进行建模预测

另外，我们的问题相对于传统推荐搜索领域，多了一层匹配决策，我们到底积攒多久的订单进行分配，对于每一个分配来说我们都面临着分或者不分，现在分还是未来分配，并且分给谁的问题，这个问题天生就可以建模为强化学习问题，目前在我们的系统中也引入了强化学习方法来优化更长期的收益



# 参考

[测试派单系统](http://bittechblog.com/article/179)

[王犇 - 滴滴是如何对用户和司机进行派单匹配的？](https://blog.csdn.net/qq_39521554/article/details/104577106)
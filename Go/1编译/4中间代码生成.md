# 2.4 中间代码生成

## 2.4.1 概述

[中间代码](https://en.wikipedia.org/wiki/Intermediate_representation)是编译器或者虚拟机使用的语言，它可以来帮助我们分析计算机程序。在编译过程中，编译器会在将源代码转换到机器码的过程中，先把源代码转换成一种中间的表示形式，即中间代码<sup>1</sup>。

很多读者可能认为中间代码没有太多价值，我们可以直接将源代码翻译成目标语言，这种看起来可行的办法实际上有很多问题，其中最主要的是：它忽略了编译器面对的复杂场景，很多编译器需要将源代码翻译成多种机器码，直接翻译高级编程语言相对比较困难。

将编程语言到机器码的过程拆成中间代码生成和机器码生成两个简单步骤可以简化该问题，中间代码是一种更接近机器语言的表示形式，对中间代码的优化和分析相比直接分析高级编程语言更容易。

我们再来回忆一下编译阶段入口的主函数 [`cmd/compile/internal/gc.Main`](https://draveness.me/golang/tree/cmd/compile/internal/gc.Main) 中关于中间代码生成的部分，这一段代码会初始化 SSA 生成的配置，在配置初始化结束后会调用 [`cmd/compile/internal/gc.funccompile`](https://draveness.me/golang/tree/cmd/compile/internal/gc.funccompile) 编译函数：

```go
func Main(archInit func(*Arch)) {
	...

	initssaconfig() // 初始化 SSA 生成的配置

	for i := 0; i < len(xtop); i++ {
		n := xtop[i]
		if n.Op == ODCLFUNC {
			funccompile(n)
		}
	}

	compileFunctions()
}
```

这一节将分别介绍配置的初始化以及函数编译两部分内容，我们会以 [`cmd/compile/internal/gc.initssaconfig`](https://draveness.me/golang/tree/cmd/compile/internal/gc.initssaconfig) 和 [`cmd/compile/internal/gc.funccompile`](https://draveness.me/golang/tree/cmd/compile/internal/gc.funccompile) 这两个函数作为入口来分析中间代码生成的具体过程和实现原理。



## 2.4.2 配置初始化

SSA 配置的初始化过程是中间代码生成之前的准备工作，在该过程中，我们会缓存可能用到的类型指针、初始化 SSA 配置和一些之后会调用的运行时函数，例如：用于处理 `defer` 关键字的 [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc)、用于创建 Goroutine 的 [`runtime.newproc`](https://draveness.me/golang/tree/runtime.newproc) 和扩容切片的 [`runtime.growslice`](https://draveness.me/golang/tree/runtime.growslice) 等，除此之外还会根据当前的目标设备初始化特定的 ABI<sup>2</sup>。我们以 [`cmd/compile/internal/gc.initssaconfig`](https://draveness.me/golang/tree/cmd/compile/internal/gc.initssaconfig) 作为入口开始分析配置初始化的过程。

```go
func initssaconfig() {
	types_ := ssa.NewTypes()

	_ = types.NewPtr(types.Types[TINTER])                             // *interface{}
	_ = types.NewPtr(types.NewPtr(types.Types[TSTRING]))              // **string
	_ = types.NewPtr(types.NewPtr(types.Idealstring))                 // **string
	_ = types.NewPtr(types.NewSlice(types.Types[TINTER]))             // *[]interface{}
	..
	_ = types.NewPtr(types.Errortype)                                 // *error
```

这个函数的执行过程总共可以分成三个部分，首先就是调用 [`cmd/compile/internal/ssa.NewTypes`](https://draveness.me/golang/tree/cmd/compile/internal/ssa.NewTypes) 初始化 [`cmd/compile/internal/ssa.Types`](https://draveness.me/golang/tree/cmd/compile/internal/ssa.Types) 结构体并调用 [`cmd/compile/internal/types.NewPtr`](https://draveness.me/golang/tree/cmd/compile/internal/types.NewPtr) 函数缓存类型的信息，[`cmd/compile/internal/ssa.Types`](https://draveness.me/golang/tree/cmd/compile/internal/ssa.Types) 中存储了所有 Go 语言中基本类型对应的指针，比如 `Bool`、`Int8`、以及 `String` 等。
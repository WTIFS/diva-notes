#### 空间分配

`mallocgc` 这个函数名一看还以为是做 GC 的，实际做的是 malloc + GC 两件事情，大部分代码都是处理空间分配

```go
// runtime/malloc.go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	
	var assistG *g                         // 进行辅助GC
	if gcBlackenEnabled != 0 {
		assistG = getg()                     // 获取当前G
		assistG.gcAssistBytes -= int64(size) // 把当前分配对象的size从辅助GC配额里扣除

		if assistG.gcAssistBytes < 0 {       // 如果扣完成负的了，则要进行辅助GC
			gcAssistAlloc(assistG)
		}
	}

	// 空间分配相关
  // ...
  // 期间可能改变 size 值

	// 如果处于 GC 期间，直接将使用的 span 标记为黑色
	if gcphase != _GCoff {
		gcmarknewobject(span, uintptr(x), size, scanSize)
	}

  // 再次进行 GC 检查
	if assistG != nil {
		assistG.gcAssistBytes -= int64(size - dataSize)
	}
	if shouldhelpgc {
		if t := (gcTrigger{kind: gcTriggerHeap}); t.test() {
			gcStart(t)
		}
	}

	return x
}
```



